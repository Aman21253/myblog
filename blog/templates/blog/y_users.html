{% extends "blog/y_base.html" %}
{% block title %}Users | MyBlog{% endblock %}
{% block content %}

<!-- TOP HEADER -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
  <div>
    <h2 class="mb-0">Users</h2>
    <div class="text-muted small">Admin can add / edit / delete users</div>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'y_users' %}?mode=create" class="btn btn-dark">+ Add User</a>
    {% if mode %}
      <a href="{% url 'y_users' %}" class="btn btn-outline-secondary">Close Form</a>
    {% endif %}
  </div>
</div>

<!-- CREATE / EDIT FORM (SAME PAGE) -->
{% if mode == "create" or mode == "edit" %}
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h5 class="mb-0 fw-bold">
          {% if mode == "edit" %}Edit User{% else %}Create User{% endif %}
        </h5>
        <div class="text-muted small">
          {% if mode == "edit" %}
            Editing: <b>{{ u.bu_first_name }} {{ u.bu_last_name }}</b> ({{ u.bu_email }})
          {% else %}
            Create new Admin / Writer / Viewer
          {% endif %}
        </div>
      </div>
      <a href="{% url 'y_users' %}" class="btn btn-outline-secondary btn-sm">Cancel</a>
    </div>

    <hr class="my-3">

    <form method="post"
          action="{% if mode == 'edit' %}{% url 'y_user_edit' u.bu_user_id %}{% else %}{% url 'y_user_create' %}{% endif %}"
          autocomplete="off">

      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label fw-semibold">First Name</label>
          <input class="form-control" name="first_name"
                 value="{{ u.bu_first_name|default:'' }}"
                 required autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Last Name</label>
          <input class="form-control" name="last_name"
                 value="{{ u.bu_last_name|default:'' }}"
                 autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Email</label>
          <input type="email" class="form-control" name="email"
                 value="{{ u.bu_email|default:'' }}"
                 required autocomplete="off">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Role</label>
          <select class="form-select" name="role">
            {% for r in roles %}
              <option value="{{ r }}" {% if u and u.bu_role == r %}selected{% endif %}>
                {{ r|title }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Status</label>
          <select class="form-select" name="status">
            {% for s in statuses %}
              <option value="{{ s }}" {% if u and u.bu_status == s %}selected{% endif %}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">
            {% if mode == "edit" %}New Password (optional){% else %}Password{% endif %}
          </label>
          <input id="password" type="password" class="form-control" name="password"
                 autocomplete="new-password"
                 placeholder="{% if mode == 'edit' %}Leave blank to keep same{% else %}Enter password{% endif %}">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">
            {% if mode == "edit" %}Confirm New Password{% else %}Confirm Password{% endif %}
          </label>
          <input id="confirm_password" type="password" class="form-control" name="confirm_password"
                 autocomplete="new-password"
                 placeholder="{% if mode == 'edit' %}Repeat new password{% else %}Repeat password{% endif %}">
        </div>

        <div class="col-md-3 d-flex align-items-end gap-2">
          <button id="submitBtn" class="btn btn-dark w-100" type="submit">
            {% if mode == "edit" %}Update{% else %}Create{% endif %}
          </button>
        </div>
      </div>

      <!-- ✅ PASSWORD STRENGTH (ADDED) -->
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="small text-muted">
            Use at least 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special.
          </div>
          <div class="small fw-semibold" id="pwdLabel">Strength: —</div>
        </div>

        <div class="progress mt-2" style="height:10px;">
          <div id="pwdBar" class="progress-bar" style="width:0%"></div>
        </div>

        <div class="small mt-2" id="matchLabel"></div>

        <ul class="small mt-2 mb-0" id="pwdRules" style="padding-left:18px;">
          <li id="rLen">Min 8 characters</li>
          <li id="rLow">At least 1 lowercase</li>
          <li id="rUp">At least 1 uppercase</li>
          <li id="rNum">At least 1 number</li>
          <li id="rSp">At least 1 special (!@#$...)</li>
        </ul>
      </div>

      {% if mode == "edit" %}
        <div class="text-muted small mt-2">
          Tip: Password fields blank छोड़ दोगे तो password same रहेगा.
        </div>
      {% endif %}
    </form>
  </div>

  <!-- ✅ PASSWORD STRENGTH SCRIPT (ADDED) -->
  <script>
  (function(){
    const pwd = document.getElementById("password");
    const cpwd = document.getElementById("confirm_password");
    const bar = document.getElementById("pwdBar");
    const label = document.getElementById("pwdLabel");
    const matchLabel = document.getElementById("matchLabel");
    const submitBtn = document.getElementById("submitBtn");

    if(!pwd || !cpwd || !bar || !submitBtn) return;

    const rules = {
      len: document.getElementById("rLen"),
      low: document.getElementById("rLow"),
      up:  document.getElementById("rUp"),
      num: document.getElementById("rNum"),
      sp:  document.getElementById("rSp"),
    };

    function ok(el, done){
      if(!el) return;
      el.style.color = done ? "green" : "#444";
      el.style.fontWeight = done ? "700" : "400";
    }

    function scorePassword(v){
      let score = 0;
      const hasLen = v.length >= 8;
      const hasLow = /[a-z]/.test(v);
      const hasUp  = /[A-Z]/.test(v);
      const hasNum = /[0-9]/.test(v);
      const hasSp  = /[^A-Za-z0-9]/.test(v);

      ok(rules.len, hasLen);
      ok(rules.low, hasLow);
      ok(rules.up,  hasUp);
      ok(rules.num, hasNum);
      ok(rules.sp,  hasSp);

      if (hasLen) score += 20;
      if (hasLow) score += 20;
      if (hasUp)  score += 20;
      if (hasNum) score += 20;
      if (hasSp)  score += 20;

      if (v.length > 0 && v.length < 8) score = Math.min(score, 20);
      return {score, strong: (hasLen && hasLow && hasUp && hasNum && hasSp)};
    }

    function setBar(score){
      bar.style.width = score + "%";
      bar.classList.remove("bg-danger","bg-warning","bg-success");
      if (score <= 40) bar.classList.add("bg-danger");
      else if (score <= 80) bar.classList.add("bg-warning");
      else bar.classList.add("bg-success");

      if (score === 0) label.textContent = "Strength: —";
      else if (score <= 40) label.textContent = "Strength: Weak";
      else if (score <= 80) label.textContent = "Strength: Medium";
      else label.textContent = "Strength: Strong";
    }

    function checkMatch(){
      const a = pwd.value || "";
      const b = cpwd.value || "";

      // if both empty (edit mode), ok
      if (!a && !b){
        matchLabel.textContent = "";
        return true;
      }

      if (a === b){
        matchLabel.textContent = "✅ Passwords match";
        matchLabel.style.color = "green";
        return true;
      } else {
        matchLabel.textContent = "❌ Passwords do not match";
        matchLabel.style.color = "crimson";
        return false;
      }
    }

    function validate(){
      const v = pwd.value || "";
      const res = scorePassword(v);
      setBar(res.score);
      const match = checkMatch();

      // If edit mode and user didn't type any password, allow submit
      const typed = (pwd.value || "").length > 0 || (cpwd.value || "").length > 0;
      if (!typed){
        submitBtn.disabled = false;
        return;
      }

      submitBtn.disabled = !(res.strong && match);
    }

    pwd.addEventListener("input", validate);
    cpwd.addEventListener("input", validate);
    validate();
  })();
  </script>
{% endif %}

<!-- SEARCH -->
<form method="get" class="card p-3 mb-3">
  <div class="row g-2 align-items-center">
    <div class="col-md-9">
      <input class="form-control" name="q" value="{{ q }}" placeholder="Search by name, email, role..." />
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button class="btn btn-dark w-100" type="submit">Search</button>
      <a class="btn btn-outline-secondary" href="{% url 'y_users' %}">Reset</a>
    </div>
  </div>
</form>

<!-- TABLE -->
<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Status</th>
        <th style="width:220px;">Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for u in users %}
        <tr>
          <td>{{ u.bu_user_id }}</td>
          <td>{{ u.bu_first_name }} {{ u.bu_last_name }}</td>
          <td>{{ u.bu_email }}</td>

          <td>
            <span class="badge text-bg-secondary">{{ u.bu_role }}</span>
          </td>

          <td>
            {% if u.bu_status == "Active" %}
              <span class="badge text-bg-success">Active</span>
            {% else %}
              <span class="badge text-bg-warning">Inactive</span>
            {% endif %}
          </td>

          <td>
            <div class="d-flex gap-2">
              <!--IMPORTANT: edit opens SAME PAGE -->
              <a class="btn btn-sm btn-outline-dark"
                 href="{% url 'y_users' %}?mode=edit&user_id={{ u.bu_user_id }}">
                Edit
              </a>

              <form method="post" action="{% url 'y_user_delete' u.bu_user_id %}">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this user?')">
                  Delete
                </button>
              </form>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6">
            <div class="alert alert-warning mb-0">No users found.</div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}