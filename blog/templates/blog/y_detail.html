{# templates/blog/y_detail.html #}
{% extends "blog/y_base.html" %}
{% block title %}{{ blog.bd_blog_title }} | MyBlog{% endblock %}

{% block content %}
<div class="page-card">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <h2 class="blog-title">{{ blog.bd_blog_title }}</h2>

      <div class="blog-meta">
        <span class="pill">Slug: {{ blog.bd_slug }}</span>
        <span class="pill">Status: {{ blog.bd_blog_status }}</span>
        <span class="pill">Views: {{ blog.bd_views }}</span>

        {% if blog.bd_published_at %}
          <span class="pill">Published: {{ blog.bd_published_at|date:"d M Y, h:i A" }}</span>
        {% elif blog.bd_updated_at %}
          <span class="pill">Updated: {{ blog.bd_updated_at|date:"d M Y, h:i A" }}</span>
        {% endif %}
      </div>

      {% if blog.bd_excerpt %}
        <p class="text-muted mt-3 mb-0">{{ blog.bd_excerpt }}</p>
      {% endif %}
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'y_home' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>

      {% if role == "admin" or role == "writer" %}
        <a href="{% url 'y_blog_edit' blog.bd_blog_id %}" class="btn btn-dark btn-sm">‚úèÔ∏è Edit</a>

        <form method="post" action="{% url 'y_blog_delete' blog.bd_blog_id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger btn-sm"
                  onclick="return confirm('Delete this blog?')">
            üóë Delete
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="divider"></div>

  <!-- Content -->
  <div class="blog-content" style="white-space: pre-wrap;">
    {{ blog.bd_blog_content }}
  </div>

  <div class="divider"></div>

  <!-- Comments Header + Like at right -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <h3 class="section-title m-0">Comments</h3>
      <span class="pill">Threaded</span>
    </div>

    <div class="d-flex align-items-center gap-2">
      <span class="pill">Total: {{ comments_roots|length }}</span>

      {% if role == "viewer" %}
        <form method="post" action="{% url 'y_blog_like_toggle' blog.bd_blog_id %}" class="d-inline">
          {% csrf_token %}
          {% if user_liked %}
            <button type="submit" class="btn btn-sm btn-outline-danger like-btn">
              ‚ù§Ô∏è Liked <span class="like-count">{{ like_count }}</span>
            </button>
          {% else %}
            <button type="submit" class="btn btn-sm btn-outline-dark like-btn">
              ü§ç Like <span class="like-count">{{ like_count }}</span>
            </button>
          {% endif %}
        </form>
      {% else %}
        <span class="pill">‚ù§Ô∏è {{ like_count }} Likes</span>
      {% endif %}
    </div>
  </div>

  <!-- Comments Thread -->
  <div class="comments-wrapper">
    {% if comments_roots %}
      {% for c in comments_roots %}
        {% include "blog/_comment.html" with c=c level=0 role=role %}
      {% endfor %}
    {% else %}
      <div class="empty-state">No comments yet. Be the first one üëÄ</div>
    {% endif %}
  </div>

  <!-- Add new root comment -->
  {% if role == "viewer" %}
    <div class="comment-form-card">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h4 class="m-0 fw-bold">Add your comment</h4>
        <span class="pill">Posting as: Viewer</span>
      </div>

      <form method="post" autocomplete="off" class="comment-form">
        {% csrf_token %}
        <textarea name="comment" rows="4" required
                  placeholder="Write your thoughts here..." autocomplete="off"></textarea>
        <button class="btn-primary" type="submit">Post Comment</button>
      </form>
    </div>
  {% endif %}

</div>

<script>
function toggleReplyForm(id) {
  const el = document.getElementById("replyForm-" + id);
  if (!el) return;
  el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
}
function toggleEditForm(id) {
  const el = document.getElementById("editForm-" + id);
  if (!el) return;
  el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
}
</script>
{% endblock %}